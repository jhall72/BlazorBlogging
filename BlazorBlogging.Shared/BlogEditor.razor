@using BlazorBlogging.Shared.Data

<div class="blog-editor">
    <div class="edit-page">
        <MudAppBar Dense="true" Fixed="false" Color="Color.Primary" Elevation="1">
            <MudText Typo="Typo.h6">@(IsEditing ? "Edit Post" : "Create Post")</MudText>
            <MudSpacer />
            @if (!string.IsNullOrEmpty(Message))
            {
                <MudAlert Severity="Severity.Success" Dense="true" NoIcon="true" Class="mr-2"
                          Style="padding: 2px 12px;">
                    @Message
                </MudAlert>
            }
            <MudSwitch T="bool" @bind-Value="Post.Published" Color="Color.Inherit" Label="Published" Class="mr-2" />
            <MudButton Variant="Variant.Filled" Size="Size.Small" OnClick="OnSave"
                       Style="background: var(--mud-palette-surface); color: var(--mud-palette-primary);">
                @(IsEditing ? "Update" : "Create")
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Inherit" Size="Size.Small" Href="@CancelHref" Class="ml-2">
                Cancel
            </MudButton>
        </MudAppBar>

        <div class="edit-page-body">
            <MudPaper Elevation="0" Class="pa-3" Style="border-bottom: 1px solid var(--mud-palette-lines-default);">
                <MudGrid Spacing="2">
                    <MudItem xs="3">
                        <MudTextField T="string" @bind-Value="Post.Title" Label="Title" Variant="Variant.Outlined"
                                      Margin="Margin.Dense" Placeholder="Post title..." />
                    </MudItem>
                    <MudItem xs="5">
                        <MudTextField T="string" @bind-Value="Post.Description" Label="Description" Variant="Variant.Outlined"
                                      Margin="Margin.Dense" Placeholder="Brief description..."
                                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.AutoAwesome"
                                      AdornmentColor="Color.Secondary" OnAdornmentClick="OnSuggestDescription"
                                      Disabled="SuggestingDescription" />
                    </MudItem>
                    <MudItem xs="4">
                        <MudTextField T="string" @bind-Value="TagsInput" @bind-Value:after="OnTagsInputChanged"
                                      Label="Tags" Variant="Variant.Outlined" Margin="Margin.Dense"
                                      Placeholder="Comma separated..."
                                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.AutoAwesome"
                                      AdornmentColor="Color.Secondary" OnAdornmentClick="OnSuggestTags"
                                      Disabled="SuggestingTags" />
                    </MudItem>
                </MudGrid>
            </MudPaper>

            <MudPaper Elevation="0" Class="pa-3" Style="border-bottom: 1px solid var(--mud-palette-lines-default);">
                <div class="d-flex align-center gap-3">
                    <MudAvatar Size="Size.Large" Variant="Variant.Outlined" Style="width: 64px; height: 64px; border-radius: 6px;">
                        @if (!string.IsNullOrEmpty(thumbnailPreviewSrc))
                        {
                            <MudImage Src="@thumbnailPreviewSrc" Alt="Thumbnail" Style="width: 100%; height: 100%; object-fit: cover;" />
                        }
                        else
                        {
                            <MudIcon Icon="@Icons.Material.Filled.Image" />
                        }
                    </MudAvatar>
                    <div style="flex: 1; display: flex; flex-direction: column; gap: 0.35rem;">
                        <MudTextField T="string" @bind-Value="Post.ThumbnailUrl" @bind-Value:after="UpdateThumbnailPreview"
                                      Label="Thumbnail URL" Variant="Variant.Outlined" Margin="Margin.Dense"
                                      Placeholder="https://..." />
                        <div class="d-flex gap-2 align-center">
                            <MudFileUpload T="IBrowserFile" Accept="image/*" FilesChanged="OnThumbnailFileSelected">
                                <ActivatorContent>
                                    <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                               StartIcon="@Icons.Material.Filled.CloudUpload">
                                        Choose File
                                    </MudButton>
                                </ActivatorContent>
                            </MudFileUpload>
                            @if (!string.IsNullOrEmpty(Post.ThumbnailBase64) || !string.IsNullOrEmpty(Post.ThumbnailUrl))
                            {
                                <MudButton Variant="Variant.Filled" Color="Color.Error" Size="Size.Small"
                                           OnClick="ClearThumbnail">
                                    Clear
                                </MudButton>
                            }
                        </div>
                    </div>
                </div>
            </MudPaper>

            <div class="edit-content">
                <RichEditor Content="@Content" ContentChanged="OnContentChanged" />
            </div>

            @if (Versions is not null)
            {
                <MudExpansionPanels Class="mt-0" Style="border-top: 1px solid var(--mud-palette-lines-default);">
                    <MudExpansionPanel @bind-Expanded="versionPanelOpen"
                                       Icon="@Icons.Material.Filled.KeyboardArrowUp">
                        <TitleContent>
                            <MudText Typo="Typo.body2">
                                Version History (@Versions.Count)
                            </MudText>
                        </TitleContent>
                        <ChildContent>
                            <div class="d-flex gap-2 align-center mb-3">
                                <MudTextField T="string" @bind-Value="newVersionDescription" Variant="Variant.Outlined"
                                              Margin="Margin.Dense" Placeholder="Change description..." Style="flex: 1;" />
                                <MudButton Variant="Variant.Filled" Color="Color.Primary" Size="Size.Small"
                                           OnClick="HandleCreateVersion">
                                    Save Version
                                </MudButton>
                            </div>

                            @if (Versions.Any())
                            {
                                <div class="d-flex flex-column gap-2">
                                    @foreach (var version in Versions)
                                    {
                                        <MudPaper Outlined="true" Class="pa-2"
                                                  Style="@(version.Id == LatestVersionId ? "border-color: var(--mud-palette-success); background: var(--mud-palette-success-lighten);" : "")">
                                            <div class="d-flex align-center justify-space-between">
                                                <div class="d-flex align-center gap-2">
                                                    <MudText Typo="Typo.body2"><strong>v@version.VersionNumber</strong></MudText>
                                                    @if (version.Id == LatestVersionId)
                                                    {
                                                        <MudChip T="string" Color="Color.Success" Size="Size.Small">Latest</MudChip>
                                                    }
                                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                        @version.CreatedAt.ToString("MMM dd, yyyy HH:mm")
                                                    </MudText>
                                                    @if (!string.IsNullOrEmpty(version.ChangeDescription))
                                                    {
                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                            &mdash; @version.ChangeDescription
                                                        </MudText>
                                                    }
                                                </div>
                                                <MudButton Variant="Variant.Outlined" Color="Color.Primary" Size="Size.Small"
                                                           OnClick="() => OnRestoreVersion.InvokeAsync(version)">
                                                    Restore
                                                </MudButton>
                                            </div>
                                        </MudPaper>
                                    }
                                </div>
                            }
                            else
                            {
                                <MudText Typo="Typo.body2" Color="Color.Secondary">No versions yet.</MudText>
                            }
                        </ChildContent>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }
        </div>
    </div>
</div>

@code {
    [Parameter] public BlogPost Post { get; set; } = new();
    [Parameter] public string Content { get; set; } = "";
    [Parameter] public EventCallback<string> ContentChanged { get; set; }
    [Parameter] public string TagsInput { get; set; } = "";
    [Parameter] public EventCallback<string> TagsInputChanged { get; set; }
    [Parameter] public bool IsEditing { get; set; }
    [Parameter] public string? Message { get; set; }
    [Parameter] public string CancelHref { get; set; } = "/";

    [Parameter] public List<PostVersion>? Versions { get; set; }
    [Parameter] public string? LatestVersionId { get; set; }

    [Parameter] public EventCallback OnSave { get; set; }
    [Parameter] public EventCallback<string> OnCreateVersion { get; set; }
    [Parameter] public EventCallback<PostVersion> OnRestoreVersion { get; set; }
    [Parameter] public EventCallback OnSuggestDescription { get; set; }
    [Parameter] public EventCallback OnSuggestTags { get; set; }
    [Parameter] public bool SuggestingDescription { get; set; }
    [Parameter] public bool SuggestingTags { get; set; }

    private bool versionPanelOpen;
    private string newVersionDescription = "";
    private string thumbnailPreviewSrc = "";

    protected override void OnParametersSet()
    {
        UpdateThumbnailPreview();
    }

    private async Task HandleCreateVersion()
    {
        await OnCreateVersion.InvokeAsync(newVersionDescription);
        newVersionDescription = "";
    }

    private async Task OnContentChanged(string value)
    {
        Content = value;
        await ContentChanged.InvokeAsync(value);
    }

    private async Task OnTagsInputChanged()
    {
        await TagsInputChanged.InvokeAsync(TagsInput);
    }

    private void UpdateThumbnailPreview()
    {
        if (!string.IsNullOrEmpty(Post.ThumbnailBase64))
            thumbnailPreviewSrc = Post.ThumbnailBase64;
        else if (!string.IsNullOrEmpty(Post.ThumbnailUrl))
            thumbnailPreviewSrc = Post.ThumbnailUrl;
        else
            thumbnailPreviewSrc = "";
    }

    private async Task OnThumbnailFileSelected(IBrowserFile? file)
    {
        if (file is null) return;

        const long maxSize = 5 * 1024 * 1024; // 5 MB
        if (file.Size > maxSize) return;

        using var stream = file.OpenReadStream(maxSize);
        using var ms = new MemoryStream();
        await stream.CopyToAsync(ms);
        var bytes = ms.ToArray();
        Post.ThumbnailBase64 = $"data:{file.ContentType};base64,{Convert.ToBase64String(bytes)}";
        Post.ThumbnailUrl = null;
        UpdateThumbnailPreview();
    }

    private void ClearThumbnail()
    {
        Post.ThumbnailUrl = null;
        Post.ThumbnailBase64 = null;
        UpdateThumbnailPreview();
    }
}
