@implements IAsyncDisposable
@inject IJSRuntime JS

<MudPaper Elevation="1" Class="rich-editor">
    <MudToolBar Dense="true" Class="editor-toolbar">
        <MudIconButton Icon="@Icons.Material.Filled.FormatBold" Size="Size.Small" Title="Bold"
                       OnClick='() => WrapSelection("**", "**")' />
        <MudIconButton Icon="@Icons.Material.Filled.FormatItalic" Size="Size.Small" Title="Italic"
                       OnClick='() => WrapSelection("*", "*")' />
        <MudIconButton Icon="@Icons.Material.Filled.FormatStrikethrough" Size="Size.Small" Title="Strikethrough"
                       OnClick='() => WrapSelection("~~", "~~")' />

        <MudDivider Vertical="true" FlexItem="true" Class="mx-1" />

        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Heading 1"
                   OnClick='() => InsertLinePrefix("# ")'>H1</MudButton>
        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Heading 2"
                   OnClick='() => InsertLinePrefix("## ")'>H2</MudButton>
        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Heading 3"
                   OnClick='() => InsertLinePrefix("### ")'>H3</MudButton>

        <MudDivider Vertical="true" FlexItem="true" Class="mx-1" />

        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Bullet List"
                   OnClick='() => InsertLinePrefix("- ")'>&#8226; List</MudButton>
        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Numbered List"
                   OnClick='() => InsertLinePrefix("1. ")'>1. List</MudButton>
        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Blockquote"
                   OnClick='() => InsertLinePrefix("> ")'>&#10077; Quote</MudButton>

        <MudDivider Vertical="true" FlexItem="true" Class="mx-1" />

        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Inline Code"
                   OnClick='() => WrapSelection("`", "`")'>&lt;/&gt;</MudButton>
        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Code Block"
                   OnClick="InsertCodeBlock">Code</MudButton>
        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Terminal / Shell Block"
                   OnClick="InsertTerminalBlock"
                   Style="background: var(--mud-palette-dark); color: var(--mud-palette-success); font-family: 'Cascadia Code', 'Fira Code', monospace; font-weight: 600;">
            &gt;_
        </MudButton>

        <MudDivider Vertical="true" FlexItem="true" Class="mx-1" />

        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Link"
                   OnClick="InsertLink">Link</MudButton>
        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Image"
                   OnClick="InsertImage">Img</MudButton>
        <MudButton Variant="Variant.Text" Size="Size.Small" Title="Horizontal Rule"
                   OnClick="InsertHorizontalRule">&mdash;</MudButton>
    </MudToolBar>

    <div class="editor-body">
        <div class="editor-pane editor-input">
            <MudText Typo="Typo.overline" Class="pane-label">Markdown</MudText>
            <textarea id="@editorId"
                      value="@Content"
                      @oninput="OnInput"
                      placeholder="Write your content in Markdown..."
                      spellcheck="false"></textarea>
        </div>
        <div class="editor-pane editor-preview">
            <MudText Typo="Typo.overline" Class="pane-label">Preview</MudText>
            <div class="blog-content" id="@previewId">
                @if (string.IsNullOrEmpty(Content))
                {
                    <p class="preview-placeholder">Preview will appear here...</p>
                }
                else
                {
                    <BlogContentView Content="@Content" />
                }
            </div>
        </div>
    </div>
</MudPaper>

@code {
    [Parameter] public string Content { get; set; } = "";
    [Parameter] public EventCallback<string> ContentChanged { get; set; }

    private string editorId = $"editor-{Guid.NewGuid():N}";
    private string previewId = $"preview-{Guid.NewGuid():N}";
    private bool hasRendered;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            hasRendered = true;
            await JS.InvokeVoidAsync("editorInterop.initScrollSync", editorId, previewId);
        }
    }

    private async Task OnInput(ChangeEventArgs e)
    {
        Content = e.Value?.ToString() ?? "";
        await ContentChanged.InvokeAsync(Content);
    }

    private async Task WrapSelection(string before, string after)
    {
        await JS.InvokeVoidAsync("editorInterop.wrapSelection", editorId, before, after);
    }

    private async Task InsertLinePrefix(string prefix)
    {
        await JS.InvokeVoidAsync("editorInterop.insertLinePrefix", editorId, prefix);
    }

    private async Task InsertText(string text)
    {
        await JS.InvokeVoidAsync("editorInterop.insertText", editorId, text);
    }

    private async Task InsertCodeBlock()
    {
        var block = "```\n{{selection}}\n```\n";
        await JS.InvokeVoidAsync("editorInterop.insertBlock", editorId, block, 4);
    }

    private async Task InsertTerminalBlock()
    {
        var block = "```terminal\n{{selection}}\n```\n";
        await JS.InvokeVoidAsync("editorInterop.insertBlock", editorId, block, 12);
    }

    private async Task InsertLink()
    {
        await WrapSelection("[", "](url)");
    }

    private async Task InsertImage()
    {
        await WrapSelection("![", "](image-url)");
    }

    private async Task InsertHorizontalRule()
    {
        await InsertText("\n---\n");
    }

    public async ValueTask DisposeAsync()
    {
        if (hasRendered)
        {
            try
            {
                await JS.InvokeVoidAsync("editorInterop.disposeScrollSync", editorId);
            }
            catch (JSDisconnectedException) { }
        }
    }
}
