@using BlazorBlogging.Shared.Data
@using BlazorBlogging.Shared.Models
@using BlazorBlogging.Shared.Service
@inject BlogService BlogService
@inject NavigationManager Nav

@if (selectedPost is not null)
{
    <BlogPostDetail Post="@selectedPost"
                    Content="@selectedContent"
                    OnBack="ClosePost" />
}
else if (posts is null)
{
    <p class="blog-list-loading">Loading...</p>
}
else if (!posts.Any())
{
    <div class="blog-list-empty">
        <p>@(EditorMode ? "No blog posts yet." : "No posts to show.")</p>
    </div>
}
else
{
    <div class="blog-grid">
        @foreach (var post in posts)
        {
            @if (EditorMode)
            {
                <div class="blog-card">
                    <div class="card-top">
                        @if (post.Published)
                        {
                            <span class="badge badge-published">Published</span>
                        }
                        else
                        {
                            <span class="badge badge-draft">Draft</span>
                        }
                        <span class="card-date">@post.CreatedAt.ToString("MMM dd, yyyy")</span>
                    </div>

                    <h2 class="card-title">@post.Title</h2>

                    @if (!string.IsNullOrEmpty(post.Description))
                    {
                        <p class="card-desc">@post.Description</p>
                    }

                    @if (post.Tags.Any())
                    {
                        <div class="card-tags">
                            @foreach (var tag in post.Tags)
                            {
                                <span class="tag-pill">@tag</span>
                            }
                        </div>
                    }

                    <div class="card-bottom">
                        @if (post.UpdatedAt.HasValue)
                        {
                            <span class="card-updated">Updated @post.UpdatedAt.Value.ToString("MMM dd")</span>
                        }
                        else
                        {
                            <span></span>
                        }
                        <div class="card-actions">
                            <button class="btn btn-sm" @onclick='() => Nav.NavigateTo($"/blogs/edit/{post.Id}")'>Edit</button>
                            @if (post.Published)
                            {
                                <button class="btn btn-sm btn-secondary" @onclick="() => TogglePublish(post.Id, false)">Unpublish</button>
                            }
                            else
                            {
                                <button class="btn btn-sm btn-outline" @onclick="() => TogglePublish(post.Id, true)">Publish</button>
                            }
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="blog-card blog-card-view" @onclick="() => OpenPost(post)">
                    <span class="card-date">@post.CreatedAt.ToString("MMM dd, yyyy")</span>
                    <h2 class="card-title">@post.Title</h2>
                    @if (!string.IsNullOrEmpty(post.Description))
                    {
                        <p class="card-desc">@post.Description</p>
                    }
                    <span class="card-read-more">Read more &rarr;</span>
                </div>
            }
        }
    </div>
}

@code {
    [Parameter] public bool EditorMode { get; set; }

    private List<BlogPostSummary>? posts;
    private BlogPostSummary? selectedPost;
    private string selectedContent = "";

    protected override async Task OnInitializedAsync()
    {
        await LoadPosts();
    }

    private async Task LoadPosts()
    {
        List<BlogPost> source;
        if (EditorMode)
            source = await BlogService.GetAllPostsAsync();
        else
            source = await BlogService.GetPublishedPostsAsync();

        posts = source.Select(p => new BlogPostSummary
        {
            Id = p.Id,
            Title = p.Title,
            Description = p.Description,
            CreatedAt = p.CreatedAt,
            UpdatedAt = p.UpdatedAt,
            Published = p.Published,
            Tags = p.Tags
        }).ToList();
    }

    private async Task TogglePublish(string id, bool publish)
    {
        var post = await BlogService.GetPostByIdAsync(id);
        if (post is null) return;
        post.Published = publish;
        await BlogService.UpdatePostAsync(post);
        await LoadPosts();
    }

    private async Task OpenPost(BlogPostSummary post)
    {
        selectedPost = post;
        selectedContent = "";

        var full = await BlogService.GetPostByIdAsync(post.Id);
        if (full is not null && !string.IsNullOrEmpty(full.LatestVersionId))
        {
            var version = await BlogService.GetVersionByIdAsync(full.LatestVersionId);
            if (version is not null)
                selectedContent = version.Content;
        }
    }

    private void ClosePost()
    {
        selectedPost = null;
        selectedContent = "";
    }
}
