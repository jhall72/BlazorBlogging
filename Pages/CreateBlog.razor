@page "/blogs/create"
@page "/blogs/edit/{Id}"
@using BlazorBlogging.Shared.Data
@using BlazorBlogging.Shared.Service
@inject BlogService BlogService
@inject AiSuggestionService AiService

<BlogEditor Post="@post"
            @bind-Content="content"
            @bind-TagsInput="tagsInput"
            IsEditing="@isEditing"
            Message="@message"
            CancelHref="/"
            Versions="@versions"
            LatestVersionId="@post.LatestVersionId"
            OnSave="SavePost"
            OnCreateVersion="CreateVersion"
            OnRestoreVersion="RestoreVersion"
            OnSuggestDescription="SuggestDescription"
            OnSuggestTags="SuggestTags"
            SuggestingDescription="@suggestingDescription"
            SuggestingTags="@suggestingTags" />

@code {
    [Parameter] public string? Id { get; set; }

    private BlogPost post = new();
    private string content = "";
    private string tagsInput = "";
    private string message = "";
    private bool isEditing;
    private List<PostVersion>? versions;

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(Id))
        {
            var existing = await BlogService.GetPostByIdAsync(Id);
            if (existing is not null)
            {
                post = existing;
                tagsInput = string.Join(", ", post.Tags);
                isEditing = true;

                if (!string.IsNullOrEmpty(post.LatestVersionId))
                {
                    var latest = await BlogService.GetVersionByIdAsync(post.LatestVersionId);
                    if (latest is not null)
                        content = latest.Content;
                }

                await LoadVersions();
            }
        }
    }

    private async Task SavePost()
    {
        post.Tags = tagsInput
            .Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
            .ToList();

        if (isEditing)
        {
            await BlogService.UpdatePostAsync(post);
            await AutoSaveVersion();
            message = "Post updated.";
        }
        else
        {
            await BlogService.CreatePostAsync(post);
            isEditing = true;
            Id = post.Id;

            var version = new PostVersion
            {
                BlogPostId = post.Id,
                Content = content,
                VersionNumber = 1.0,
                ChangeDescription = "Initial version"
            };
            await BlogService.CreateVersionAsync(version);
            await LoadVersions();

            message = "Post created.";
        }
    }

    private async Task LoadVersions()
    {
        if (!string.IsNullOrEmpty(post.Id))
        {
            versions = await BlogService.GetVersionsByPostIdAsync(post.Id);
        }
    }

    private async Task CreateVersion(string description)
    {
        if (string.IsNullOrEmpty(post.Id)) return;

        double nextVersion = 1.0;
        if (versions is not null && versions.Any())
        {
            nextVersion = versions.Max(v => v.VersionNumber) + 1.0;
        }

        var version = new PostVersion
        {
            BlogPostId = post.Id,
            Content = content,
            VersionNumber = nextVersion,
            ChangeDescription = description
        };

        await BlogService.CreateVersionAsync(version);
        message = $"Version {nextVersion} saved.";
        await LoadVersions();
    }

    private async Task AutoSaveVersion()
    {
        if (string.IsNullOrEmpty(post.Id)) return;

        await LoadVersions();

        double nextVersion = 1.0;
        if (versions is not null && versions.Any())
        {
            nextVersion = versions.Max(v => v.VersionNumber) + 1.0;
        }

        var version = new PostVersion
        {
            BlogPostId = post.Id,
            Content = content,
            VersionNumber = nextVersion,
            ChangeDescription = "Auto-saved on update"
        };

        await BlogService.CreateVersionAsync(version);
        await LoadVersions();
    }

    private async Task RestoreVersion(PostVersion version)
    {
        content = version.Content;
        message = $"Restored to v{version.VersionNumber}.";
    }

    private bool suggestingDescription;
    private bool suggestingTags;

    private async Task SuggestDescription()
    {
        if (string.IsNullOrWhiteSpace(post.Title) && string.IsNullOrWhiteSpace(content))
        {
            message = "Add a title or content first so a description can be suggested.";
            return;
        }

        suggestingDescription = true;
        StateHasChanged();

        try
        {
            post.Description = await AiService.SuggestDescriptionAsync(post.Title, content);
        }
        catch (Exception ex)
        {
            message = $"Description suggestion failed: {ex.Message}";
        }
        finally
        {
            suggestingDescription = false;
        }
    }

    private async Task SuggestTags()
    {
        if (string.IsNullOrWhiteSpace(post.Title) && string.IsNullOrWhiteSpace(content))
        {
            message = "Add a title or content first so tags can be suggested.";
            return;
        }

        suggestingTags = true;
        StateHasChanged();

        try
        {
            tagsInput = await AiService.SuggestTagsAsync(post.Title, post.Description, content);
        }
        catch (Exception ex)
        {
            message = $"Tag suggestion failed: {ex.Message}";
        }
        finally
        {
            suggestingTags = false;
        }
    }
}
