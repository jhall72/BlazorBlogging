@page "/blogs"
@using BlazorBlogging.Data
@using BlazorBlogging.Service
@inject BlogService BlogService

<h1>Blog Posts</h1>

@if (posts is null)
{
    <p>Loading...</p>
}
else if (!posts.Any())
{
    <p>No blog posts yet. <a href="/blogs/create">Create one!</a></p>
}
else
{
    <div class="blog-list">
        @foreach (var post in posts)
        {
            <div class="blog-card">
                <div class="blog-card-header">
                    <h2>@post.Title</h2>
                    @if (post.Published)
                    {
                        <span class="badge published">Published</span>
                    }
                    else
                    {
                        <span class="badge draft">Draft</span>
                    }
                </div>
                @if (!string.IsNullOrEmpty(post.Description))
                {
                    <p class="blog-description">@post.Description</p>
                }
                <div class="blog-meta">
                    <span>Created: @post.CreatedAt.ToString("MMM dd, yyyy")</span>
                    @if (post.UpdatedAt.HasValue)
                    {
                        <span>Updated: @post.UpdatedAt.Value.ToString("MMM dd, yyyy")</span>
                    }
                    @if (post.Tags.Any())
                    {
                        <span>Tags: @string.Join(", ", post.Tags)</span>
                    }
                </div>
                <div class="blog-actions">
                    <a class="btn" href="/blogs/edit/@post.Id">Edit</a>
                    @if (post.Published)
                    {
                        <button class="btn btn-secondary" @onclick="() => UnpublishPost(post)">Unpublish</button>
                    }
                    else
                    {
                        <button class="btn" @onclick="() => PublishPost(post)">Publish</button>
                    }
                </div>
            </div>
        }
    </div>
}

@code {
    private List<BlogPost>? posts;

    protected override async Task OnInitializedAsync()
    {
        await LoadPosts();
    }

    private async Task LoadPosts()
    {
        posts = await BlogService.GetAllPostsAsync();
    }

    private async Task UnpublishPost(BlogPost post)
    {
        post.Published = false;
        await BlogService.UpdatePostAsync(post);
        await LoadPosts();
    }

    private async Task PublishPost(BlogPost post)
    {
        post.Published = true;
        await BlogService.UpdatePostAsync(post);
        await LoadPosts();
    }
}
